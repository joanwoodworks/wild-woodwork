---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const products = (await getCollection('products')).sort((a, b) =>
  b.data.date.valueOf() - a.data.date.valueOf()
);

const settings = await import('../content/settings/general.json');

// Group products by category
const productsByCategory = products.reduce((acc, product) => {
  const category = product.data.category || 'Other';
  if (!acc[category]) acc[category] = [];
  acc[category].push(product);
  return acc;
}, {} as Record<string, typeof products>);

const categories = Object.keys(productsByCategory);

// Create global product index for alternating layout
let globalProductIndex = 0;
---

<Layout title={settings.title} description={settings.tagline}>
  <!-- Hero Section -->
  <section class="hero" id="hero">
    <div class="hero-image" style={settings.hero_image ? `background-image: url(${settings.hero_image})` : ''}></div>
  </section>

  <!-- Sticky Navigation -->
  <nav class="main-nav" id="main-nav">
    <div class="nav-container">
      <a href="#hero" class="nav-logo">
        <svg class="logo-icon" fill="currentColor" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg">
          <path d="m218.94 363.19c0 55.027 49.438 99.789 110.21 99.789 10.637 0.007813 21.223-1.3945 31.488-4.168v161.61h-98.398c-4.3477 0-7.8711 3.5273-7.8711 7.875 0 4.3477 3.5234 7.8711 7.8711 7.8711h220.42c4.3477 0 7.8711-3.5234 7.8711-7.8711 0-4.3477-3.5234-7.875-7.8711-7.875h-106.27v-74.594l33.684-23.316c21.168 9.5352 45.391 9.6172 66.621 0.22656 2.5195 2.25 5.2852 4.207 8.2422 5.8438 7.1445 3.8945 15.164 5.9062 23.301 5.8477 25.949-1.4922 49.246-16.391 61.488-39.32 10.594-17.289 13.848-38.086 9.0469-57.781-3.2734-12.668-11.406-23.531-22.641-30.238 2.5117-24.129-7.0859-45.539-25.324-55.602v0.003906c-4.9922-2.7383-10.438-4.5391-16.074-5.3242 2.2461-9.4766 3.3711-19.188 3.3516-28.93 0-55.465-35.77-100.71-79.797-99.77-13.469-32.777-40.336-53.625-69.77-53.625-43.406 0-78.723 44.762-78.723 99.789 0 2.0312 0.0625 4.0938 0.17969 6.2969-42.742 14.625-71.027 51.395-71.027 93.266zm157.44 133.23c5.1953 6.7461 11.387 12.664 18.355 17.547l-18.355 12.707zm163.39-86.238c-0.67578 3.6562 1.293 7.2852 4.7227 8.707 1.0781 0.4375 2.1289 0.92969 3.1484 1.4805 7.9805 4.5742 13.73 12.223 15.902 21.16 3.6641 15.613 0.96484 32.039-7.5 45.656-15.16 26.16-43.676 38.574-63.559 27.551v0.003906c-3.1758-1.7734-6.0117-4.0898-8.3789-6.8516-1.4961-1.7227-3.6641-2.7148-5.9492-2.7148-1.3789-0.003907-2.7344 0.35156-3.9375 1.0312-14.785 8.0977-32.184 9.9922-48.363 5.2578l49.391-34.195h-0.003906c3.457-2.5156 4.2734-7.3281 1.8438-10.844-2.4336-3.5156-7.2305-4.4453-10.801-2.0977l-57.598 39.871h-0.003906c-14.672-8.2578-25.574-21.883-30.414-38.012-3.7695-12.867-2.1484-26.715 4.4922-38.363 6.7227-10.426 16.629-18.406 28.25-22.746 11.621-4.3438 24.336-4.8164 36.246-1.3477 3.668 0.86328 7.4336-0.99219 8.9805-4.4258 0.99609-2.2305 2.1016-4.4062 3.3164-6.5234 15.168-26.16 43.715-38.527 63.566-27.551 13.793 7.5703 20.293 25.211 16.648 44.953zm-239.31-127.06c3.6719-1.0352 6.0703-4.5625 5.6914-8.3594-0.39453-3.6953-0.60156-7.4102-0.62109-11.129 0-46.344 28.25-84.043 62.977-84.043 24.316 0 46.711 19.137 57.062 48.758 1.2188 3.4766 4.6797 5.6445 8.3359 5.2188 1.8086-0.22266 3.6289-0.34375 5.4492-0.35938 34.723 0 62.977 37.699 62.977 84.035v-0.003906c0.003906 9.8711-1.3477 19.695-4.0156 29.199-22.238 4.5352-41.363 18.609-52.301 38.492-0.44141 0.78906-0.86719 1.5273-1.2656 2.2969l-0.003906 0.003906c-25.215-4.7383-51.09 3.9219-68.367 22.891v-128.2c0-4.3477-3.5234-7.8711-7.8711-7.8711-4.3477 0-7.875 3.5234-7.875 7.8711v99.078l-41.668-41.668h0.003906c-3.0898-2.9844-8-2.9414-11.035 0.097656-3.0391 3.0352-3.0781 7.9453-0.097656 11.035l52.797 52.797v39.07c-10.18 3.2383-20.801 4.8906-31.488 4.9023-52.09 0-94.465-37.699-94.465-84.043 0.003906-36.738 26.438-68.918 65.781-80.074z"/>
        </svg>
        <span>{settings.title}</span>
      </a>
      <button class="burger" id="burger" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <ul class="nav-menu" id="nav-menu">
        {categories.map(category => (
          <li><a href={`#${category.toLowerCase().replace(/\s+/g, '-')}`}>{category}</a></li>
        ))}
        <li><a href="#about">Kontakt</a></li>
      </ul>
    </div>
  </nav>

  <!-- Product Sections -->
  {categories.map((category) => (
    <section class="product-section" id={category.toLowerCase().replace(/\s+/g, '-')}>
      <h2 class="category-title">{category}</h2>
      {productsByCategory[category].map((product) => {
        const isEven = globalProductIndex % 2 === 0;
        globalProductIndex++;
        return (
          <div class="product" data-reverse={!isEven}>
            <div class="product-content">
              <div class="product-text-container">
                <h3 class="product-title">{product.data.title}</h3>
                <div class="product-text" data-speed="0.8">
                  <p class="product-description">{product.data.description}</p>
                  {product.data.wood && <p class="product-meta">Materjal: {product.data.wood}</p>}
                  {product.data.dimensions && <p class="product-meta">Suurus: {product.data.dimensions}</p>}
                  {product.data.price && <p class="product-price">{product.data.price}</p>}
                </div>
              </div>
              <div class="product-images" data-speed="1.2">
                {product.data.image && (
                  <div class="product-image">
                    <img src={product.data.image} alt={product.data.title} loading="lazy" />
                  </div>
                )}
                {product.data.gallery?.map((img) => (
                  <div class="product-image">
                    <img src={img.image} alt={product.data.title} loading="lazy" />
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      })}
    </section>
  ))}

  <!-- About Section -->
  <section class="about-section" id="about">
    <div class="about-content">
      <h2>Kontakt</h2>
      <p>{settings.about}</p>
      <div class="contact-info">
        {settings.email && <p><a href={`mailto:${settings.email}`}>{settings.email}</a></p>}
        {settings.instagram_url && (
          <p><a href={settings.instagram_url} target="_blank" rel="noopener">{settings.instagram}</a></p>
        )}
      </div>
    </div>
  </section>
</Layout>

<style>
  :root {
    --color-bg-dark: #1C3A2D;
    --color-gold: #D4AF69;
    --color-bg-light: #F5F2ED;
    --color-text-dark: #2C2416;
    --color-text-light: #666;
  }

  :global(body) {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    background: var(--color-bg-light);
  }

  /* Hero Section */
  .hero {
    height: 100vh;
    position: relative;
    overflow: hidden;
  }

  .hero-image {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    background-color: #2C2416;
  }

  @media (max-width: 768px) {
    .hero-image {
      background-attachment: scroll;
    }
  }

  /* Navigation */
  .main-nav {
    position: sticky;
    top: 0;
    background: rgba(28, 58, 45, 0.95);
    backdrop-filter: blur(10px);
    z-index: 1000;
    transform: translateY(0);
    transition: transform 0.3s ease;
    box-shadow: 0 2px 20px rgba(0,0,0,0.3);
  }

  .main-nav.visible {
    transform: translateY(0);
  }

  .nav-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .nav-logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-gold);
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .logo-icon {
    width: 40px;
    height: 40px;
  }

  .burger {
    display: none;
    flex-direction: column;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
  }

  .burger span {
    width: 25px;
    height: 2px;
    background: var(--color-gold);
    transition: all 0.3s;
  }

  .burger.active span:nth-child(1) {
    transform: rotate(45deg) translate(7px, 7px);
  }

  .burger.active span:nth-child(2) {
    opacity: 0;
  }

  .burger.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -7px);
  }

  .nav-menu {
    display: flex;
    gap: 2.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-menu a {
    color: var(--color-gold);
    text-decoration: none;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: opacity 0.2s;
  }

  .nav-menu a:hover {
    opacity: 0.7;
  }

  /* Product Sections */
  .product-section {
    min-height: 100vh;
    padding: 8rem 2rem;
  }

  .category-title {
    font-size: clamp(2.5rem, 5vw, 4rem);
    text-align: center;
    margin-bottom: 6rem;
    font-weight: 300;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-bg-dark);
  }

  .product {
    margin-bottom: 15rem;
  }

  .product-content {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6rem;
    align-items: start;
  }

  .product[data-reverse="true"] .product-content {
    direction: rtl;
  }

  .product[data-reverse="true"] .product-text-container,
  .product[data-reverse="true"] .product-images {
    direction: ltr;
  }

  .product-text-container {
    position: sticky;
    top: 150px;
  }

  .product-title {
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 300;
    margin-bottom: 2rem;
    color: var(--color-bg-dark);
  }

  .product-description {
    font-size: 1.1rem;
    line-height: 1.8;
    color: var(--color-text-light);
    margin-bottom: 2rem;
  }

  .product-meta {
    font-size: 0.95rem;
    color: #999;
    margin-bottom: 0.5rem;
  }

  .product-price {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-gold);
    margin-top: 2rem;
  }

  .product-images {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .product-image {
    width: 100%;
    aspect-ratio: 4/5;
    overflow: hidden;
    border-radius: 4px;
  }

  .product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .product-image:hover img {
    transform: scale(1.05);
  }

  /* About Section */
  .about-section {
    min-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8rem 2rem;
    background: var(--color-bg-dark);
  }

  .about-content {
    max-width: 800px;
    text-align: center;
  }

  .about-content h2 {
    font-size: clamp(2.5rem, 5vw, 4rem);
    font-weight: 300;
    margin-bottom: 2rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-gold);
  }

  .about-content p {
    font-size: 1.2rem;
    line-height: 1.8;
    color: rgba(212, 175, 105, 0.85);
    margin-bottom: 3rem;
  }

  .contact-info {
    display: flex;
    gap: 3rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .contact-info a {
    color: var(--color-gold);
    text-decoration: none;
    font-size: 1.1rem;
    transition: opacity 0.2s;
    border-bottom: 1px solid transparent;
  }

  .contact-info a:hover {
    opacity: 0.8;
    border-bottom-color: var(--color-gold);
  }

  /* Mobile Styles */
  @media (max-width: 768px) {
    .burger {
      display: flex;
    }

    .nav-menu {
      position: fixed;
      top: 0;
      right: -100%;
      height: 100vh;
      width: 70%;
      max-width: 300px;
      background: var(--color-bg-dark);
      flex-direction: column;
      padding: 6rem 2rem 2rem;
      gap: 2rem;
      transition: right 0.3s ease;
      box-shadow: -2px 0 20px rgba(0,0,0,0.5);
    }

    .nav-menu.active {
      right: 0;
    }

    .product-content {
      grid-template-columns: 1fr;
      gap: 5rem;
      display: flex;
      flex-direction: column;
    }

    .product[data-reverse="true"] .product-content {
      direction: ltr;
    }

    .product-text-container {
      position: relative;
    }

    .product-title {
      position: sticky;
      top: 72px;
      background: var(--color-gold);
      color: var(--color-bg-dark);
      z-index: 10;
      padding: 1rem 2rem;
      margin-bottom: 1rem;
      width: 100vw;
      margin-left: -2rem;
    }

    .product-text {
      position: relative;
    }

    .product-images {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .product-image {
      width: 100vw;
      margin-left: -2rem;
      margin-bottom: 1.5rem;
    }

    .product-image img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
      aspect-ratio: 4/5;
    }

    .category-title {
      font-size: 2rem;
      margin-bottom: 3rem;
    }

    .product {
      margin-bottom: 8rem;
    }

    .product-section {
      padding: 4rem 2rem;
    }
  }
</style>

<script>
  // Navigation visibility on scroll
  const nav = document.getElementById('main-nav');
  const hero = document.getElementById('hero');
  let lastScroll = 0;

  window.addEventListener('scroll', () => {
    const heroBottom = hero?.offsetHeight || 0;
    const currentScroll = window.scrollY;

    if (currentScroll > heroBottom) {
      nav?.classList.add('visible');
    } else {
      nav?.classList.remove('visible');
    }

    lastScroll = currentScroll;
  });

  // Burger menu toggle
  const burger = document.getElementById('burger');
  const navMenu = document.getElementById('nav-menu');

  burger?.addEventListener('click', () => {
    burger.classList.toggle('active');
    navMenu?.classList.toggle('active');
  });

  // Close menu when clicking a link
  navMenu?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => {
      burger?.classList.remove('active');
      navMenu?.classList.remove('active');
    });
  });

  // Smooth scroll for anchor links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href') || '');
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });

  // Parallax effect for products (desktop only)
  function handleParallax() {
    // Disable parallax on mobile
    if (window.innerWidth <= 768) return;

    const products = document.querySelectorAll('.product');

    products.forEach(product => {
      const rect = product.getBoundingClientRect();
      const isVisible = rect.top < window.innerHeight && rect.bottom > 0;

      if (isVisible) {
        const scrolled = window.innerHeight - rect.top;
        const rate = scrolled * 0.3;

        const text = product.querySelector('.product-text') as HTMLElement;
        const images = product.querySelector('.product-images') as HTMLElement;

        if (text && images) {
          text.style.transform = `translateY(${rate * 0.3}px)`;
          images.style.transform = `translateY(${-rate * 0.15}px)`;
        }
      }
    });
  }

  window.addEventListener('scroll', handleParallax);
  window.addEventListener('resize', handleParallax);
  handleParallax(); // Initial call
</script>
</Layout>

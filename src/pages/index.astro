---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const products = (await getCollection('products')).sort((a, b) =>
  b.data.date.valueOf() - a.data.date.valueOf()
);

const settings = await import('../content/settings/general.json');

// Group products by category
const productsByCategory = products.reduce((acc, product) => {
  const category = product.data.category || 'Other';
  if (!acc[category]) acc[category] = [];
  acc[category].push(product);
  return acc;
}, {} as Record<string, typeof products>);

const categories = Object.keys(productsByCategory);

// Create global product index for alternating layout
let globalProductIndex = 0;
---

<Layout title={settings.title} description={settings.tagline}>
  <!-- Hero Section -->
  <section class="hero" id="hero">
    <div class="hero-image" style={settings.hero_image ? `background-image: url(${settings.hero_image})` : ''}></div>
  </section>

  <!-- Sticky Navigation -->
  <nav class="main-nav" id="main-nav">
    <div class="nav-container">
      <a href="#hero" class="nav-logo">{settings.title}</a>
      <button class="burger" id="burger" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <ul class="nav-menu" id="nav-menu">
        {categories.map(category => (
          <li><a href={`#${category.toLowerCase().replace(/\s+/g, '-')}`}>{category}</a></li>
        ))}
        <li><a href="#about">About</a></li>
      </ul>
    </div>
  </nav>

  <!-- Product Sections -->
  {categories.map((category) => (
    <section class="product-section" id={category.toLowerCase().replace(/\s+/g, '-')}>
      <h2 class="category-title">{category}</h2>
      {productsByCategory[category].map((product) => {
        const isEven = globalProductIndex % 2 === 0;
        globalProductIndex++;
        return (
          <div class="product" data-reverse={!isEven}>
            <div class="product-content">
              <div class="product-text-container">
                <h3 class="product-title">{product.data.title}</h3>
                <div class="product-text" data-speed="0.8">
                  <p class="product-description">{product.data.description}</p>
                  {product.data.wood && <p class="product-meta">Wood: {product.data.wood}</p>}
                  {product.data.dimensions && <p class="product-meta">Size: {product.data.dimensions}</p>}
                  {product.data.price && <p class="product-price">{product.data.price}</p>}
                </div>
              </div>
              <div class="product-images" data-speed="1.2">
                {product.data.image && (
                  <div class="product-image">
                    <img src={product.data.image} alt={product.data.title} loading="lazy" />
                  </div>
                )}
                {product.data.gallery?.map((img) => (
                  <div class="product-image">
                    <img src={img.image} alt={product.data.title} loading="lazy" />
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      })}
    </section>
  ))}

  <!-- About Section -->
  <section class="about-section" id="about">
    <div class="about-content">
      <h2>About</h2>
      <p>{settings.about}</p>
      <div class="contact-info">
        {settings.email && <p><a href={`mailto:${settings.email}`}>{settings.email}</a></p>}
        {settings.instagram_url && (
          <p><a href={settings.instagram_url} target="_blank" rel="noopener">{settings.instagram}</a></p>
        )}
      </div>
    </div>
  </section>
</Layout>

<style>
  :global(body) {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
  }

  /* Hero Section */
  .hero {
    height: 100vh;
    position: relative;
    overflow: hidden;
  }

  .hero-image {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center top;
    background-attachment: fixed;
    background-color: #2C2416;
  }

  /* Navigation */
  .main-nav {
    position: sticky;
    top: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 1000;
    transform: translateY(-100%);
    transition: transform 0.3s ease;
    box-shadow: 0 2px 20px rgba(0,0,0,0.1);
  }

  .main-nav.visible {
    transform: translateY(0);
  }

  .nav-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .nav-logo {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2C2416;
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .burger {
    display: none;
    flex-direction: column;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
  }

  .burger span {
    width: 25px;
    height: 2px;
    background: #2C2416;
    transition: all 0.3s;
  }

  .burger.active span:nth-child(1) {
    transform: rotate(45deg) translate(7px, 7px);
  }

  .burger.active span:nth-child(2) {
    opacity: 0;
  }

  .burger.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -7px);
  }

  .nav-menu {
    display: flex;
    gap: 2.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-menu a {
    color: #2C2416;
    text-decoration: none;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: opacity 0.2s;
  }

  .nav-menu a:hover {
    opacity: 0.6;
  }

  /* Product Sections */
  .product-section {
    min-height: 100vh;
    padding: 8rem 2rem;
  }

  .category-title {
    font-size: clamp(2.5rem, 5vw, 4rem);
    text-align: center;
    margin-bottom: 6rem;
    font-weight: 300;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #2C2416;
  }

  .product {
    margin-bottom: 15rem;
  }

  .product-content {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6rem;
    align-items: start;
  }

  .product[data-reverse="true"] .product-content {
    direction: rtl;
  }

  .product[data-reverse="true"] .product-text-container,
  .product[data-reverse="true"] .product-images {
    direction: ltr;
  }

  .product-text-container {
    position: sticky;
    top: 150px;
  }

  .product-title {
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 300;
    margin-bottom: 2rem;
    color: #2C2416;
  }

  .product-description {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #666;
    margin-bottom: 2rem;
  }

  .product-meta {
    font-size: 0.95rem;
    color: #999;
    margin-bottom: 0.5rem;
  }

  .product-price {
    font-size: 1.5rem;
    font-weight: 600;
    color: #8B4513;
    margin-top: 2rem;
  }

  .product-images {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .product-image {
    width: 100%;
    aspect-ratio: 4/5;
    overflow: hidden;
    border-radius: 4px;
  }

  .product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .product-image:hover img {
    transform: scale(1.05);
  }

  /* About Section */
  .about-section {
    min-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8rem 2rem;
    background: #F9F7F4;
  }

  .about-content {
    max-width: 800px;
    text-align: center;
  }

  .about-content h2 {
    font-size: clamp(2.5rem, 5vw, 4rem);
    font-weight: 300;
    margin-bottom: 2rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #2C2416;
  }

  .about-content p {
    font-size: 1.2rem;
    line-height: 1.8;
    color: #666;
    margin-bottom: 3rem;
  }

  .contact-info {
    display: flex;
    gap: 3rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .contact-info a {
    color: #8B4513;
    text-decoration: none;
    font-size: 1.1rem;
    transition: opacity 0.2s;
  }

  .contact-info a:hover {
    opacity: 0.6;
  }

  /* Mobile Styles */
  @media (max-width: 768px) {
    .burger {
      display: flex;
    }

    .nav-menu {
      position: fixed;
      top: 0;
      right: -100%;
      height: 100vh;
      width: 70%;
      max-width: 300px;
      background: white;
      flex-direction: column;
      padding: 6rem 2rem 2rem;
      gap: 2rem;
      transition: right 0.3s ease;
      box-shadow: -2px 0 20px rgba(0,0,0,0.1);
    }

    .nav-menu.active {
      right: 0;
    }

    .product-content {
      grid-template-columns: 1fr;
      gap: 0;
      display: flex;
      flex-direction: column;
    }

    .product[data-reverse="true"] .product-content {
      direction: ltr;
    }

    .product-text-container {
      position: relative;
    }

    .product-title {
      position: sticky;
      top: 80px;
      background: white;
      z-index: 10;
      padding: 1rem 0;
      margin-bottom: 1rem;
    }

    .product-text {
      position: relative;
      margin-bottom: 2rem;
    }

    .product-images {
      gap: 1.5rem;
      margin-top: 2rem;
      width: 100vw;
      margin-left: -2rem;
      padding: 0 2rem;
    }

    .product-image {
      width: 100%;
      aspect-ratio: 4/5;
    }

    .category-title {
      font-size: 2rem;
      margin-bottom: 3rem;
    }

    .product {
      margin-bottom: 8rem;
    }

    .product-section {
      padding: 4rem 2rem;
    }
  }
</style>

<script>
  // Navigation visibility on scroll
  const nav = document.getElementById('main-nav');
  const hero = document.getElementById('hero');
  let lastScroll = 0;

  window.addEventListener('scroll', () => {
    const heroBottom = hero?.offsetHeight || 0;
    const currentScroll = window.scrollY;

    if (currentScroll > heroBottom) {
      nav?.classList.add('visible');
    } else {
      nav?.classList.remove('visible');
    }

    lastScroll = currentScroll;
  });

  // Burger menu toggle
  const burger = document.getElementById('burger');
  const navMenu = document.getElementById('nav-menu');

  burger?.addEventListener('click', () => {
    burger.classList.toggle('active');
    navMenu?.classList.toggle('active');
  });

  // Close menu when clicking a link
  navMenu?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => {
      burger?.classList.remove('active');
      navMenu?.classList.remove('active');
    });
  });

  // Smooth scroll for anchor links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href') || '');
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });

  // Parallax effect for products (desktop only)
  function handleParallax() {
    // Disable parallax on mobile
    if (window.innerWidth <= 768) return;

    const products = document.querySelectorAll('.product');

    products.forEach(product => {
      const rect = product.getBoundingClientRect();
      const isVisible = rect.top < window.innerHeight && rect.bottom > 0;

      if (isVisible) {
        const scrolled = window.innerHeight - rect.top;
        const rate = scrolled * 0.3;

        const text = product.querySelector('.product-text') as HTMLElement;
        const images = product.querySelector('.product-images') as HTMLElement;

        if (text && images) {
          text.style.transform = `translateY(${rate * 0.3}px)`;
          images.style.transform = `translateY(${-rate * 0.15}px)`;
        }
      }
    });
  }

  window.addEventListener('scroll', handleParallax);
  window.addEventListener('resize', handleParallax);
  handleParallax(); // Initial call
</script>
</Layout>
